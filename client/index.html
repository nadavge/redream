<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.dev.js"></script>
</head>
<body>
  <div id="container" style="height:200px; overflow-y: scroll; border:2px #aaa solid;">
    <table id="connections" style="width:200px">
    </table>
  </div>
  <!-- App Logic -->
  <script>
    state = {
      connections: {
        current: [],
        history: []
      }
    }

    const socket = io('http://localhost:8000')

    function addConnections(new_connections) {
      let container = document.getElementById("container")
      let connectionList = document.getElementById("connections")
      let shouldScroll = Math.abs(container.scrollHeight - (container.scrollTop + container.clientHeight)) < 5

      new_connections.forEach((connection) => {
        let connectionRow = document.createElement("tr")
        let connectionColSrcIP = document.createElement("td")
        let connectionColSrcPort = document.createElement("td")
        let connectionColDestIP = document.createElement("td")
        let connectionColDestPort = document.createElement("td")

        connectionColSrcIP.appendChild(document.createTextNode(connection.src_ip))
        connectionColSrcPort.appendChild(document.createTextNode(connection.src_port))
        connectionColDestIP.appendChild(document.createTextNode(connection.dest_ip))
        connectionColDestPort.appendChild(document.createTextNode(connection.dest_port))

        connectionRow.appendChild(connectionColSrcIP)
        connectionRow.appendChild(connectionColSrcPort)
        connectionRow.appendChild(connectionColDestIP)
        connectionRow.appendChild(connectionColDestPort)

        connectionList.appendChild(connectionRow)
      })

      if (shouldScroll) {
        container.scrollTo(0, container.scrollHeight - container.clientHeight)
      }
    }

    socket.on('connect', (data) => {
      console.log("connection established")
    })

    socket.on('sync_state', (data) => {
      state = data
      document.getElementById("connections").innerHTML = ""
      addConnections(state.connections.current)
    })

    socket.on('new_connection', (data) => {
      addConnections([data])
    })

  </script>
</body>
</html>